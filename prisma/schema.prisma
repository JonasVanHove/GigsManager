generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Gig {
  id String @id @default(cuid())

  // ── Event details ──────────────────────────────────────
  eventName       String
  date            DateTime
  performers      String // band name or comma-separated member names
  numberOfMusicians Int
  
  // ── Band members for this gig ──────────────────────────
  bandMembers     GigBandMember[]

  // ── Financials ─────────────────────────────────────────
  isCharity         Boolean @default(false) // whether this is a charity/pro bono performance
  performanceFee    Float           // music fee — split among musicians
  technicalFee      Float  @default(0) // optional — belongs to manager, not split
  managerBonusType  String @default("fixed") // "fixed" | "percentage"
  managerBonusAmount Float @default(0) // bonus value ($ or %)

  // ── Fee claims — whether manager claims these fees for this gig ──
  claimPerformanceFee Boolean @default(true)
  claimTechnicalFee   Boolean @default(true)
  technicalFeeClaimAmount Float? // amount of technical fee to claim (null = claim all)

  // ── Payment handling ───────────────────────────────────
  managerHandlesDistribution Boolean @default(true) // whether manager handles payment split to band members

  // ── Payment tracking ───────────────────────────────────
  paymentReceived     Boolean   @default(false)
  paymentReceivedDate DateTime?
  bandPaid            Boolean   @default(false)
  bandPaidDate        DateTime?

  // ── Advance payments ────────────────────────────────────
  advanceReceivedByManager Float @default(0) // Advance amount you received from client
  advanceToMusicians Float @default(0)        // Advance amount you paid to musicians

  // ── Meta ───────────────────────────────────────────────
  bookingDate DateTime @default(now()) // when the booking was made (default: now, but editable)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── User ownership — every gig belongs to one user ─────
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([paymentReceived])
  @@index([bandPaid])
}

model User {
  id String @id @default(cuid())

  // Supabase Auth UID (from auth.users table)
  supabaseId String @unique

  email String @unique
  name  String?

  // All gigs belonging to this user
  gigs        Gig[]
  settings    UserSettings?
  investments Investment[]
  bandMembers BandMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserSettings {
  id String @id @default(cuid())

  // Which currency to display amounts in (ISO 4217 code)
  currency String @default("EUR")

  // Whether the user (manager) claims these fee components
  claimPerformanceFee Boolean @default(true)
  claimTechnicalFee   Boolean @default(true)

  // Theme preference: "light" | "dark" | "system"
  theme String @default("system")

  // Owner
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Investment {
  id String @id @default(cuid())

  // Investment details
  amount      Float
  description String?
  date        DateTime @default(now())

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([date])
}

// ── Band Members & Relationships ─────────────────────────────────
model BandMember {
  id String @id @default(cuid())

  // Member details
  name  String
  email String?
  phone String?
  notes String?

  // Owner (the user who manages this band member)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Gigs this member participated in
  gigs GigBandMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name]) // unique member name per user
  @@index([userId])
}

// ── Junction table: which band members performed in which gigs ────
model GigBandMember {
  id String @id @default(cuid())

  // The gig and band member
  gigId String
  gig   Gig    @relation(fields: [gigId], references: [id], onDelete: Cascade)

  bandMemberId String
  bandMember   BandMember @relation(fields: [bandMemberId], references: [id], onDelete: Cascade)

  // How much did this member earn for this gig?
  earnedAmount Float @default(0)
  paidAmount   Float @default(0)  // how much has been paid to them already

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gigId, bandMemberId])
  @@index([gigId])
  @@index([bandMemberId])
}